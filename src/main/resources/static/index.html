<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>File Upload</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
        }

        body {
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: sans-serif;
            background-color: #f9f9f9;
        }

        #container {
            height: 80vh;
            text-align: center;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 70vw;
            max-height: 80vh;
            overflow-y: auto;
        }

        button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }

        #result {
            height: 45vh;
            margin-top: 20px;

            /* ìŠ¤í¬ë¡¤ ì„¤ì • */
            max-height: 58vh;
            overflow-y: auto;
            text-align: left;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background: #f1f1f1;
            font-weight: normal;
            color: #333;
            font-size: 14px;
        }
    </style>
</head>
<body>

<div id="container">
    <h1>Salesforce íŒŒì¼ ì—…ë¡œë“œ</h1>

    <!-- ë¡œê·¸ì¸ ë²„íŠ¼ -->
    <button onclick="window.location.href='/login'">ë¡œê·¸ì¸</button>

    <!-- ì—…ë¡œë“œ ë²„íŠ¼ -->
    <button data-id="cafe" onclick="upload(this)">íŒŒì¼</button>

    <!-- ì§„í–‰ë¥  ë°” -->
    <div style="margin-top: 20px; text-align: left;">
        <div id="progress-label">ì§„í–‰ë¥ : 0%</div>
        <div style="background: #ddd; border-radius: 8px; overflow: hidden; height: 20px;">
            <div id="progress-bar" style="height: 100%; width: 0; background: #4caf50;"></div>
        </div>
    </div>

    <!-- ì§„í–‰ ê±´ìˆ˜ -->
    <div id="progress-count" style="margin-top: 5px; font-size: 14px; color: #555;">0ê±´ / 0ê±´</div>

    <!-- ë‚¨ì€ ì‹œê°„ -->
    <div id="eta-time" style="margin-top: 5px; font-size: 14px; color: #777;">â³ ì˜ˆìƒ ë‚¨ì€ ì‹œê°„: ê³„ì‚° ì¤‘...</div>

    <div id="result"></div>
</div>

<script>
    const params = new URLSearchParams(window.location.search);
    const msg = params.get('message');
    if (msg === 'token_refreshed') {
        document.getElementById('result').innerText = 'âœ… í† í°ì´ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.';

        const url = new URL(window.location);
        url.searchParams.delete('message');
        window.history.replaceState({}, '', url);
    }

    let startTime = null;  // ì „ì—­ ë³€ìˆ˜

    function upload(button) {
        startTime = new Date();  // ì‹œì‘ ì‹œê° ê¸°ë¡
        const dataId = button.getAttribute('data-id');
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = "";

        const source = new EventSource(`/upload?dataId=${encodeURIComponent(dataId)}`);

        source.onmessage = function(event) {
            if (event.data.startsWith("progress:")) {

                const progressPayload = event.data.split(":")[1];
                const [percentStr, processedStr, totalStr] = progressPayload.split(",");

                const percent = parseFloat(percentStr);
                const processed = parseInt(processedStr);
                const total = parseInt(totalStr);

                updateProgressBar(percent, processed, total);
            } else {
                const line = document.createElement('div');
                line.textContent = event.data;
                resultDiv.appendChild(line);
                resultDiv.scrollTop = resultDiv.scrollHeight;

                // ğŸ‘‰ ì¤„ ìˆ˜ ì œí•œ: 1000ì¤„ ë„˜ìœ¼ë©´ ì•ì—ì„œë¶€í„° ì‚­ì œ
                const MAX_LINES = 1000;
                while (resultDiv.children.length > MAX_LINES) {
                    resultDiv.removeChild(resultDiv.firstChild);
                }

                if (event.data.includes("âœ… ë” ì´ìƒ ì²˜ë¦¬í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤")) {
                    const endTime = new Date();
                    const totalSeconds = Math.round((endTime - startTime) / 1000);
                    const formatted = formatSeconds(totalSeconds);
                    const timeDiv = document.createElement('div');
                    timeDiv.textContent = `â± ì´ ì†Œìš” ì‹œê°„: ${formatted}`;
                    resultDiv.appendChild(timeDiv);
                }
            }
        };

        function updateProgressBar(percent, processed, total) {
            const bar = document.getElementById("progress-bar");
            const label = document.getElementById("progress-label");
            const count = document.getElementById("progress-count");

            bar.style.width = percent + "%";
            label.textContent = "ì§„í–‰ë¥ : " + percent.toFixed(1) + "%";
            count.textContent = processed + "ê±´ / " + total + "ê±´";

            // ì˜ˆìƒ ë‚¨ì€ ì‹œê°„ ê³„ì‚°
            if (startTime && processed > 0) {
                const elapsedSec = (new Date() - startTime) / 1000;
                const avgPerItem = elapsedSec / processed;
                const remaining = total - processed;
                const remainingSec = Math.round(avgPerItem * remaining);
                const formatted = formatSeconds(remainingSec);

                // ì•„ë˜ì— ì¶œë ¥
                const etaDiv = document.getElementById("eta-time");
                etaDiv.textContent = "â³ ì˜ˆìƒ ë‚¨ì€ ì‹œê°„: " + formatted;
            }
        }

        function formatSeconds(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            // ë‘ ìë¦¬ ìˆ˜ë¡œ ë§ì¶”ê¸° ìœ„í•´ padStart ì‚¬ìš©
            const hh = String(h).padStart(2, '0');
            const mm = String(m).padStart(2, '0');
            const ss = String(s).padStart(2, '0');
            return `${hh}:${mm}:${ss}`;
        }

        source.onerror = function(event) {
            source.close();
            const errorLine = document.createElement('div');
            errorLine.textContent = 'âŒ ì—°ê²° ì¢…ë£Œ';
            resultDiv.appendChild(errorLine);
        };
    }

</script>

</body>
</html>
